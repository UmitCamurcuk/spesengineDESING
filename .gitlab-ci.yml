image: docker:24.0

services:
  - name: docker:24.0-dind
    command: ["--mtu=1460"]

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

stages:
  - build

build_and_push_ui:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "test" || $CI_COMMIT_BRANCH == "prod"'
      when: on_success
    - when: never
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "test" ]; then
        TAG="test"
        EXTRA_TAG="test-$CI_COMMIT_SHORT_SHA"
        API_URL="https://testapi.spesengine.com/api"
        ASSET_URL="https://testapi.spesengine.com"
        APP_ENV="test"
      else
        TAG="prod"
        EXTRA_TAG="prod-$CI_COMMIT_SHORT_SHA"
        API_URL="https://api.spesengine.com/api"
        ASSET_URL="https://api.spesengine.com"
        APP_ENV="production"
      fi

      echo "Branch=$CI_COMMIT_BRANCH TAG=$TAG EXTRA_TAG=$EXTRA_TAG"
      echo "VITE_API_BASE_URL=$API_URL"
      echo "VITE_ASSET_BASE_URL=$ASSET_URL"
      echo "VITE_APP_ENVIRONMENT=$APP_ENV"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - >
      docker build
      --build-arg VITE_API_BASE_URL="$API_URL"
      --build-arg VITE_ASSET_BASE_URL="$ASSET_URL"
      --build-arg VITE_APP_ENVIRONMENT="$APP_ENV"
      -t "$CI_REGISTRY_IMAGE:$TAG" .
    - docker push "$CI_REGISTRY_IMAGE:$TAG"
    - docker tag "$CI_REGISTRY_IMAGE:$TAG" "$CI_REGISTRY_IMAGE:$EXTRA_TAG"
    - docker push "$CI_REGISTRY_IMAGE:$EXTRA_TAG"